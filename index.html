<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confess Your Sins</title>
    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="manifest" href="icons/site.webmanifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#00aba9">
    <meta name="theme-color" content="#282828">
</head>
<body>
    <audio src="public/sounds/male-choir.wav" id="sound"></audio>
    <div class="title-section">
        <div class="title-row">
            <h1>Forgive Me</h1>
            <div class="tooltip">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2c5.514 0 10 4.486 10 10s-4.486 10-10 10-10-4.486-10-10 4.486-10 10-10zm0-2c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2.033 16.01c.564-1.789 1.632-3.932 1.821-4.474.273-.787-.211-1.136-1.74.209l-.34-.64c1.744-1.897 5.335-2.326 4.113.613-.763 1.835-1.309 3.074-1.621 4.03-.455 1.393.694.828 1.819-.211.153.25.203.331.356.619-2.498 2.378-5.271 2.588-4.408-.146zm4.742-8.169c-.532.453-1.32.443-1.761-.022-.441-.465-.367-1.208.164-1.661.532-.453 1.32-.442 1.761.022.439.466.367 1.209-.164 1.661z"/></svg>
                <span class="tooltiptext"><h4>What is this?</h4>You are able to enter a single confession that will be anonymously added to a collection of other confessions. After youâ€™ve confessed, you can view other confessions.</p></span>
            </div>
        </div>
        <h3>Secretly confess your sins.</h3>
    </div>
    <div class="form-section">
        <form id="confessionForm">
            <textarea maxlength="200" id="confessionInput" placeholder="Enter your confession"></textarea>
        </form>
    </div>
    <div class="button-section">
        <button id="confessButton" type="submit" form="confessionForm">Confess</button>
        <button id="nextButton" type="next">Next Confession</button>
        <h3 id="confessMessage">You have confessed.</h3>
    </div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(() => {
    const form = $("#confessionForm");
    const confessionInput = $("#confessionInput");
    const confessButton = $("#confessButton");
    const nextButton = $("#nextButton");
    const confessMessage = $("#confessMessage");
    const confessSound = document.getElementById('sound');
    
    const resetConfessionsInput = () => {
        confessionInput.val('');
        confessionInput.prop("readonly", true);
    }

    const displayConfession = (data) => {
        confessionInput.attr("placeholder", data[0].confession);
    }

    const sleep = (ms) => {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    const playSound = () => {
        confessSound.play();
    }

    async function changeState() {
        resetConfessionsInput();
        playSound();
        confessButton.fadeOut();
        await sleep(500);
        confessMessage.fadeIn();
        await sleep(3000);
        confessMessage.fadeOut();
        await sleep(500);
        nextButton.fadeIn();
        getConfession();
    }

    const getConfession = () => {
        fetch("/getRandConfession", {method : "get"}).then((response) => {
            return response.json();
        }).then((data) => {
            displayConfession(data);
        });
    }

    form.submit((e) => {
        e.preventDefault();

        fetch("/", {
            method : "post",
            body : JSON.stringify({
                confession : confessionInput.val(),
                id : document.cookie.split("=")[1]
            }),
            headers : {
                "Content-Type" : "application/json; charset=utf-8"
            }
        }).then((response) => {
            return response.json();
        })
        changeState();
    });

    nextButton.click(function() {
        getConfession();
    });
});
</script>
</html>